<!DOCTYPE html><html lang="en"><head><!-- Blog theme--><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="David A. Ball"><meta name=""><title>Blog</title><!-- Bootstrap core CSS--><link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet"><!-- Custom fonts for this template--><link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:100,200,300,400,500,600,700,800,900" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i" rel="stylesheet"><link href="/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet"><link href="/vendor/devicons/css/devicons.min.css" rel="stylesheet"><link href="/vendor/devicon/devicon.min.css" rel="stylesheet"><link href="/vendor/simple-line-icons/css/simple-line-icons.css" rel="stylesheet"><!-- Custom styles for this template--><link href="/layouts/blog/css/blog.min.css" rel="stylesheet"><style type="text/css">.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></head><body id="page-top"><div class="navbar navbar-expand-lg fixed-top navbar-dark bg-primary"><div class="container"><a class="navbar-brand" href="/">David A. Ball</a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarResponsive"><ul class="navbar-nav"><li class="nav-item"><a class="nav-link" href="/blog">Blog</a></li><li class="nav-item"><a class="nav-link" href="/">Portfolio</a></li><li class="nav-item"><a class="nav-link" href="/resume">Resume</a></li></ul></div></div></div><div class="container"><div class="card"><div class="card-body"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle d-block" data-ad-client="ca-pub-8937572456576531" data-ad-slot="5297465010" data-ad-format="auto"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div><div class="card"><div class="card-body"><h1 class="card-title post-title">Technician Tools Live Drive</h1><h4 class="card-subtitle mb-2 text-muted post-meta"><i class="fa fa-calendar"></i> 
published:
 26 November 2012 
@
 7:38 am <i class="fa fa-user"></i> 
author: daball <i class="fa fa-tags"></i> windows node.js<!--if blog.post.disqus_id| 
i.fa.fa-comment
| 
a.disqus-comment-count(data-disqus-identifier=post.disqus_id, href=post.permalink+'#disqus_thread')
  | Comments--></h4></div></div><div class="card"><div class="card-body"><p class="card-text"><p><strong>NOTICE: THE FOLLOWING ARTICLE REPRESENTS A WORK IN PROGRESS. PLEASE BE PATIENT AS I COMPLETE MY RESEARCH AND COMPILE THE RESULTS HERE. IF YOU HAVE ANY COMMENTS TO IMPROVE THE RESEARCH, BE SURE TO LEAVE A COMMENT BELOW. THANKS!</strong></p>
<p>This article details my concept of the ideal approach for provisioning a "Technician Tools Live Drive" (TM) environment conducive to installing and repairing Windows 2000, Windows XP, Windows Vista, Windows Server 2008, Windows 7, Windows Server 2008 R2, Windows 8, or Windows Server 2012 environments by deploying customized Windows PE images via PXE network, live USB hard disk, or CD/DVD or ISO image. This could theoretically be deployed in many other ways as well, including deployment over the Internet (or through a proxy) or by arbitrarily inserting entries into the BCD store on the local system.</p>
<div id="extended"></div>
<p>The system will access tools stored on the Technician PC (where available) and/or the boot device (where available). The Windows PE system will leverage Node.js to establish a web server interface to administer Windows Setup either locally or remotely. The Windows PE system will then allow the local user to launch a web browser in order to interact with the system. In addition, remote access to the live system will be provided over the web browser. Moreover, when the target system comes up, the Technician PC will launch the web browser connection to the Windows PE system.</p>
<h2 id="1-prerequisites">1 Prerequisites</h2>
<p>You will need at least two machines: the Technician PC and the target PC.</p>
<p>On the Technician PC, you will need the following:</p>
<ul>
<li><em>Operating System:</em> Windows 8, Windows 7, Windows Server 2012, Windows Server 2008 R2, Windows Vista, or Windows Server 2008</li>
<li><em>Installed:</em> <a href="http://www.microsoft.com/en-us/download/details.aspx?id=30652" target="_blank">Windows Assessment and Deployment Kit (ADK) for Windows 8</a></li>
<li><em>Installed:</em> <a href="http://www.microsoft.com/en-us/download/details.aspx?id=5753" target="_blank">Windows Automated Installation Kit (AIK) for Windows 7</a></li>
<li><em>Installed:</em> <a href="http://www.nodejs.org/" target="_blank">Node.js for Windows</a></li>
<li><em>Installed:</em> <a href="http://msysgit.github.com/" target="_blank">Github for Windows](<a href="http://windows.github.com/">http://windows.github.com/</a>) <em>(recommended)</em> or [Git for Windows</a></li>
<li><em>Downloaded:</em> <a href="http://sourceforge.net/projects/dhcpserver/" target="_blank">Open DHCP Server</a> or your choice of another DHCP server on the network.</li>
<li><em>Downloaded:</em> <a href="http://sourceforge.net/projects/tftp-server/" target="_blank">Open TFTP Server</a> or your choice of another TFTP server on the network.</li>
<li>DHCP authorization on the current LAN, or an extra NIC in the Technician PC for a second Ethernet.</li>
<li>Copies of the all of the installation media that you intend to deploy.</li>
</ul>
<p>The process detailed here should take the average technician and computer between one and two hours besides the amount of time it takes to burn the ISOs to discs, the time it takes to copy files from the installation media, and the time it takes to copy files onto the USB disk. So the total accumulation of time could take anywhere between one hour and eight hours, depending on the amount of data you are copying and the rate at which you can copy the data.</p>
<h2 id="2-prepare-installation-environment">2 Prepare Installation Environment</h2>
<p>Run the following commands as <strong>Administrator</strong> at the <em>Deployment and Imaging Tools Environment</em> command prompt to prepare the installation environment.</p>
<ol>
<li><p>Set system-level environment variables. You may have to adjust `KitsRoot` to your Windows ADK installation location, but `KitsRoot` should already be provided at the *Deployment and Imaging Tools Environment* command prompt. AIK may have to be adjusted to point to your Windows Automated Installation Kit for Windows 7.</p>
<pre><code class="batch language-batch">set KitsRoot=C:\Program Files (x86)\Windows Kits\8.0\
call "%KitsRoot%Assessment and Deployment Kit\Deployment Tools\DandISetEnv.bat"
set AIK=C:\Program Files\Windows AIK</code></pre>

</li>
<li><p>Set application environment variables.</p>
<pre><code class="batch language-batch">set ADK=%KitsRoot%Assessment and Deployment Kit
set pe4cabsx86=%ADK%\Windows Preinstallation Environment\x86\WinPE_OCs
set pe4cabsamd64=%ADK%\Windows Preinstallation Environment\amd64\WinPE_OCs
set pe3cabsx86=%AIK%\Tools\PETools\x86\WinPE_FPs
set pe3cabsamd64=%AIK%\Tools\PETools\amd64\WinPE_FPs
set pe3cabsia64=%AIK%\Tools\PETools\ia64\WinPE_FPs</code></pre>

</li>
</li><p>Set configuration environment variables. You may customize these as you wish. I recommend changing `LiveDrive`, `LiveHostName`, `LiveShareName`, `LiveUserName`, and `LiveUserPassword` to accomodate your environment.</p>
<pre><code class="batch language-batch">set LiveTitle=Technician Tools Live Drive
set LiveDrive=C:\LiveDrive
set LiveScripts=%LiveDrive%\scripts
set LiveMedia=%LiveDrive%\media
set LiveTools=%LiveDrive%\tools
set LiveHostName=192.168.1.100
set LiveShareName=LiveDrive
set LiveUserName=LiveDrive
set LiveUserPassword=liveDrive012
set ISORoot=%LiveDrive%\ISOs
set TFTPRoot=%LiveDrive%\TFTPRoot
set USBRoot=%LiveDrive%\USBRoot</code></pre>

</li>
<li><p>Set more application environment variables.</p>
<pre><code class="batch language-batch">set PE4root=%LiveDrive%\TempPE4
set PE4x86=%PE4root%\x86
set PE4amd64=%PE4root%\amd64
set PE3root=%LiveDrive%\TempPE3
set PE3x86=%PE3root%\x86
set PE3amd64=%PE3root%\amd64
set PE3ia64=%PE3root%\ia64</code></pre>

</li>
<li><p>Create project structure, e.g., `C:\LiveDrive`.</p>
<pre><code class="batch language-batch">mkdir "%LiveDrive%"
mkdir "%LiveScripts%"
mkdir "%LiveMedia%"
mkdir "%LiveTools%"
mkdir "%PE4root%"
mkdir "%PE3root%"
mkdir "%ISORoot%"
mkdir "%ISORoot%"\x86
mkdir "%ISORoot%"\amd64
mkdir "%ISORoot%"\x86amd64combo
mkdir "%ISORoot%"\ia64
mkdir "%TFTPRoot%"
mkdir "%TFTPRoot%"\Boot
mkdir "%USBRoot%"
mkdir "%USBRoot%"\Boot
mkdir "%USBRoot%"\media</code></pre>

</li>
<li><p>Create a new user for accessing the remote file share.</p>
<pre><code class="batch language-batch">net user "%LiveUserName%" "%LiveUserPassword%" /ADD</code></pre>

</li>
<li><p>Share the `LiveDrive` folder onto the network, with a share name like `LiveDrive`.</p>
<pre><code class="batch language-batch">net share "%LiveShareName%"="%LiveDrive%" /GRANT:Everyone,FULL /UNLIMITED</code></pre>

</li>
<li><p>Set security permissions for the remote access user on the shared project folder.</p>
<pre><code class="batch language-batch">icacls "%LiveDrive%" /grant "%LiveUserName%":F /inheritance:e</code></pre>

</li>
</ol>
<h2 id="3-custom-scripts">3 Custom Scripts</h2>
<p>Proceed using the same <em>Deployment and Imaging Tools Environment</em> command prompt as <strong>Administrator</strong> to prepare the startup environment for Windows PE.</p>
<h3 id="31-batch-file-startnetcmd">3.1 Batch file: startnet.cmd</h3>
<p>This is a replacement for the 'startnet.cmd' script found inside of a generic Windows PE image. Run these commands to generate the 'startnet.cmd' script.</p>
<pre><code class="batch language-batch">echo @echo off&gt;"%LiveScripts%"\startnet.cmd
echo set LiveTitle=%LiveTitle%&gt;&gt;"%LiveScripts%"\startnet.cmd
echo set LiveDriveLetter=L:&gt;&gt;"%LiveScripts%"\startnet.cmd
echo set LiveDrive=LiveDriveLetter\&gt;&gt;"%LiveScripts%"\startnet.cmd
echo set LiveHostName=%LiveHostName%&gt;&gt;"%LiveScripts%"\startnet.cmd
echo set LiveShareName=%LiveShareName%&gt;&gt;"%LiveScripts%"\startnet.cmd
echo set LiveUserName=%LiveUserName%&gt;&gt;"%LiveScripts%"\startnet.cmd
echo set LiveUserPassword=%LiveUserPassword%&gt;&gt;"%LiveScripts%"\startnet.cmd
echo title %LiveTitle%&gt;&gt;"%LiveScripts%"\startnet.cmd
echo echo Initializing network services . . .&gt;&gt;"%LiveScripts%"\startnet.cmd
echo wpeinit&gt;&gt;"%LiveScripts%"\startnet.cmd
echo echo Mounting network drive at %LiveDriveLetter% = \\%LiveHostName%\%LiveShareName% . . .&gt;&gt;"%LiveScripts%"\startnet.cmd
echo net use %LiveDriveLetter% "\\%LiveHostName%\%LiveShareName%" /USER:"%LiveUserName%" "%LiveUserPassword%"&gt;&gt;"%LiveScripts%"\startnet.cmd
echo cscript.exe /Nologo bootstrap.js&gt;&gt;"%LiveScripts%"\startnet.cmd
REM DISABLED: echo echo Rebooting . . .&gt;&gt;"%LiveScripts%"\startnet.cmd
REM DISABLED: echo wpeutil reboot&gt;&gt;"%LiveScripts%"\startnet.cmd</code></pre>
<h3 id="32-script-bootstrapjs">3.2 Script: bootstrap.js</h3>
<p>Save this script into <code>scripts\bootstrap.js</code>:</p>
<pre><code class="js language-js">var fso = WScript.CreateObject("Scripting.FileSystemObject");
var wshsh = WScript.CreateObject("WScript.Shell");
var env = wshsh.Environment("Process");

//array of objects like { path: string, packages: array, type: string }
var discoveredRepos = function detectRepos () {
var repos = [];
var drives = new Enumerator(fso.Drives);
for (; !drives.atEnd(); drives.moveNext()) {
var drive = drives.item();
if (fso.FolderExists(drive.DriveLetter + ":\\tools")
&amp;&amp; fso.FileExists(drive.DriveLetter + ":\\tools\\repo.json")) {
 var pkgsfile = fso.OpenTextFile(drive.DriveLetter + ":\\tools\\repo.json", ForReading=1);
 var pkgstxt = pkgsfile.ReadAll();
 pkgsfile.Close();
 var repoType = function DriveTypeDesc(typeCode) {
  switch (typeCode) {
   case 1: return "Removable";
   case 2: return "Fixed";
   case 3: return "Network";
   case 4: return "CD-ROM";
   case 5: return "RAM Disk";
   default:return "Unknown";
  }
  }(drive.DriveType);
  repos[repos.length] = { path: drive.DriveLetter + ":\\tools\\", packages: eval(pkgstxt), type: repoType };
 }
}
}
}();

livedrive = function () {
var drives = new Enumerator(fso.Drives);
for (; !drives.atEnd(); drives.moveNext()) {
 var drive = drives.item();
 if (fso.FolderExists(drive.DriveLetter + ":\\scripts")) {
  return drive.DriveLetter + ":\\";
 }
}
WScript.StdOut.WriteLine(
 "WARNING: Could not locate scripts folder on the Technician Tools Live Drive.\n" +
 "     Tools will probably be unavailable for this session.\n");
 return "";
}();

var SystemRoot = env("SystemRoot");

/*WScript.Echo("Live Drive found at " + livedrive + ".\nDeploying current version of toolkit to " + windows + " . . .");

var fso = WScript.CreateObject("Scripting.FileSystemObject")
, folder = fso.GetFolder(livedrive + "scripts")
, files = new Enumerator(folder.Files);

for (; !files.atEnd(); files.moveNext()) {
var file = files.item();
WScript.Echo("Copying " + file.Path + " to " + SystemRoot + "\\System32\\" + file.Name);
fso.CopyFile(file.Path, SystemRoot + "\\System32\\" + file.Name);
}*/</code></pre>
<h3 id="33-nodejs-acquire-web-root">3.3 Node.JS: Acquire web root</h3>
<p>You will need to download the following ZIP file and expand it to the <code>%LiveDrive%\scripts\liveserver</code> folder.</p>
<h2 id="4-prepare-windows-pe-4">4 Prepare Windows PE 4</h2>
<p>Proceed using the same <em>Deployment and Imaging Tools Environment</em> command prompt as <strong>Administrator</strong> to prepare the startup environment for Windows PE.</p>
<h3 id="41-prepare-x86-image">4.1 Prepare x86 Image</h3>
<p>Create a new Windows PE 4 image for x86.</p>
<pre><code class="batch language-batch">copype.cmd x86 "%PE4x86%"</code></pre>
<p>Mount the new x86 Windows PE 4 image.</p>
<pre><code class="batch language-batch">imagex /mountrw "%PE4x86%"\media\sources\boot.wim 1 "%PE4x86%"\mount</code></pre>
<p>Add packages to Windows PE 4 x86 image.</p>
<pre><code class="batch language-batch">dism /image:"%PE4x86%"\mount /Add-Package /PackagePath:"%pe4cabsx86%\WinPE-WMI.cab"
dism /image:"%PE4x86%"\mount /Add-Package /PackagePath:"%pe4cabsx86%\WinPE-SecureStartup.cab"
dism /image:"%PE4x86%"\mount /Add-Package /PackagePath:"%pe4cabsx86%\WinPE-NetFx4.cab"
dism /image:"%PE4x86%"\mount /Add-Package /PackagePath:"%pe4cabsx86%\WinPE-Scripting.cab"
dism /image:"%PE4x86%"\mount /Add-Package /PackagePath:"%pe4cabsx86%\WinPE-HTA.cab"
dism /image:"%PE4x86%"\mount /Add-Package /PackagePath:"%pe4cabsx86%\WinPE-PowerShell3.cab"
dism /image:"%PE4x86%"\mount /Add-Package /PackagePath:"%pe4cabsx86%\WinPE-EnhancedStorage.cab"
dism /image:"%PE4x86%"\mount /Add-Package /PackagePath:"%pe4cabsx86%\WinPE-DismCmdlets.cab"
dism /image:"%PE4x86%"\mount /Add-Package /PackagePath:"%pe4cabsx86%\WinPE-StorageWMI.cab"
imagex /commit "%PE4x86%"\mount</code></pre>
<p>Install custom scripts into Windows PE 4 x86 image.</p>
<pre><code class="batch language-batch">copy /Y "%LiveScripts%"\startnet.cmd "%PE4x86%"\mount\Windows\System32
copy /Y "%LiveScripts%"\bootstrap.js "%PE4x86%"\mount\Windows\System32
imagex /commit "%PE4x86%"\mount</code></pre>
<h3 id="42-prepare-amd64-image">4.2 Prepare amd64 Image</h3>
<p>Create Windows PE 4 image for amd64.</p>
<pre><code class="batch language-batch">copype.cmd amd64 "%PE4amd64%"</code></pre>
<p>Mount the new amd64 Windows PE 4 image.</p>
<pre><code class="batch language-batch">imagex /mountrw "%PE4amd64%"\media\sources\boot.wim 1 "%PE4amd64%"\mount</code></pre>
<p>Add packages to Windows PE 4 amd64 image.</p>
<pre><code class="batch language-batch">dism /image:"%PE4amd64%"\mount /Add-Package /PackagePath:"%pe4cabsamd64%\WinPE-WMI.cab"
dism /image:"%PE4amd64%"\mount /Add-Package /PackagePath:"%pe4cabsamd64%\WinPE-SecureStartup.cab"
dism /image:"%PE4amd64%"\mount /Add-Package /PackagePath:"%pe4cabsamd64%\WinPE-NetFx4.cab"
dism /image:"%PE4amd64%"\mount /Add-Package /PackagePath:"%pe4cabsamd64%\WinPE-Scripting.cab"
dism /image:"%PE4amd64%"\mount /Add-Package /PackagePath:"%pe4cabsamd64%\WinPE-HTA.cab"
dism /image:"%PE4amd64%"\mount /Add-Package /PackagePath:"%pe4cabsamd64%\WinPE-PowerShell3.cab"
dism /image:"%PE4amd64%"\mount /Add-Package /PackagePath:"%pe4cabsamd64%\WinPE-EnhancedStorage.cab"
dism /image:"%PE4amd64%"\mount /Add-Package /PackagePath:"%pe4cabsamd64%\WinPE-DismCmdlets.cab"
dism /image:"%PE4amd64%"\mount /Add-Package /PackagePath:"%pe4cabsamd64%\WinPE-StorageWMI.cab"
imagex /commit "%PE4amd64%"\mount</code></pre>
<p>Install custom scripts into Windows PE 4 amd64 image.</p>
<pre><code class="batch language-batch">copy /Y "%LiveScripts%"\startnet.cmd "%PE4amd64%"\mount\Windows\System32
copy /Y "%LiveScripts%"\bootstrap.js "%PE4amd64%"\mount\Windows\System32
imagex /commit "%PE4amd64%"\mount</code></pre>
<h3 id="43-assemble-windows-pe-4-for-isousbtftp-boot">4.3 Assemble Windows PE 4 for ISO/USB/TFTP Boot</h3>
<p>Copy files needed for x86 ISO boot.</p>
<pre><code class="batch language-batch">xcopy /S /Y "%PE4x86%"\media\*.* "%ISORoot%"\x86
ren "%ISORoot%"\x86\sources\boot.wim bootpe4x86.wim</code></pre>
<p>Copy files needed for amd64 ISO boot.</p>
<pre><code class="batch language-batch">xcopy /S /Y "%PE4x86%"\media\*.* "%USBRoot%"
del "%USBRoot%"\sources\boot.wim</code></pre>
<p>Deploy both images to USB root.</p>
<pre><code class="batch language-batch">copy /Y "%PE4x86%"\media\sources\boot.wim "%USBRoot%"\sources\bootpe4x86.wim
copy /Y "%PE4amd64%"\media\sources\boot.wim "%USBRoot%"\sources\bootpe4amd64.wim</code></pre>
<p>Copy files needed for PXE boot.</p>
<pre><code class="batch language-batch">xcopy /S /Y "%PE4x86%"\media\*.* "%TFTPRoot%"
copy /Y "%PE4x86%"\mount\Windows\Boot\PXE\*.* "%TFTPRoot%"\Boot
del /Q "%TFTPRoot%"\sources\boot*.wim</code></pre>
<p>Deploy both images to TFTP root.</p>
<pre><code class="batch language-batch">copy /Y "%PE4x86%"\media\sources\boot.wim "%TFTPRoot%"\sources\bootpe4x86.wim
copy /Y "%PE4amd64%"\media\sources\boot.wim "%TFTPRoot%"\sources\bootpe4amd64.wim</code></pre>
<p><em>Optional:</em> Usability Hack: Remove the press F12 for Network Servicing prompt.</p>
<pre><code class="batch language-batch">ren "%TFTPRoot%"\Boot\pxeboot.com pxeboot.com.disabled
copy /Y "%TFTPRoot%"\Boot\pxeboot.n12 "%TFTPRoot%"\Boot\pxeboot.com</code></pre>
<h3 id="44-unmount-windows-pe-4-images">4.4 Unmount Windows PE 4 images</h3>
<p>Unmount both images.</p>
<pre><code class="batch language-batch">imagex /unmount "%PE4x86%"\mount
imagex /unmount "%PE4amd64%"\mount</code></pre>
<h3 id="45-prepare-bcd-stores">4.5 Prepare BCD Stores</h3>
<p>Edit boot configuration database (BCD) store for x86 ISO container.</p>
<pre><code class="batch language-batch">bcdedit /store "%ISORoot%"\x86\Boot\BCD /set {bootmgr} displaybootmenu true
bcdedit /store "%ISORoot%"\x86\Boot\BCD /create {ramdiskoptions} /d "%LiveTitle% - Windows PE 4 CD (x86)"
bcdedit /store "%ISORoot%"\x86\Boot\BCD /set {ramdiskoptions} ramdisksdidevice boot
bcdedit /store "%ISORoot%"\x86\Boot\BCD /set {ramdiskoptions} ramdisksdipath \boot\boot.sdi
bcdedit /store "%ISORoot%"\x86\Boot\BCD /set {default} description "%LiveTitle% - Windows PE 4 CD (x86)"
bcdedit /store "%ISORoot%"\x86\Boot\BCD /set {default} osdevice ramdisk=[boot]\sources\bootpe4x86.wim,{ramdiskoptions}
bcdedit /store "%ISORoot%"\x86\Boot\BCD /set {default} device ramdisk=[boot]\sources\bootpe4x86.wim,{ramdiskoptions}</code></pre>
<p>Edit boot configuration database (BCD) store for amd64 ISO container.</p>
<pre><code class="batch language-batch">bcdedit /store "%ISORoot%"\amd64\Boot\BCD /set {bootmgr} displaybootmenu true
bcdedit /store "%ISORoot%"\amd64\Boot\BCD /create {ramdiskoptions} /d "%LiveTitle% - Windows PE 4 CD (amd64)"
bcdedit /store "%ISORoot%"\amd64\Boot\BCD /set {ramdiskoptions} ramdisksdidevice boot
bcdedit /store "%ISORoot%"\amd64\Boot\BCD /set {ramdiskoptions} ramdisksdipath \boot\boot.sdi
bcdedit /store "%ISORoot%"\amd64\Boot\BCD /set {default} description "%LiveTitle% - Windows PE 4 CD (amd64)"
bcdedit /store "%ISORoot%"\amd64\Boot\BCD /set {default} osdevice ramdisk=[boot]\sources\bootpe4amd64.wim,{ramdiskoptions}
bcdedit /store "%ISORoot%"\amd64\Boot\BCD /set {default} device ramdisk=[boot]\sources\bootpe4amd64.wim,{ramdiskoptions}</code></pre>
<p>Edit boot configuration database (BCD) store for USB container.</p>
<pre><code class="batch language-batch">bcdedit /store "%USBRoot%"\Boot\BCD /set {bootmgr} displaybootmenu true
bcdedit /store "%USBRoot%"\Boot\BCD /create {ramdiskoptions} /d "%LiveTitle% - Windows PE 4 USB (amd64)"
bcdedit /store "%USBRoot%"\Boot\BCD /set {ramdiskoptions} ramdisksdidevice boot
bcdedit /store "%USBRoot%"\Boot\BCD /set {ramdiskoptions} ramdisksdipath \boot\boot.sdi
bcdedit /store "%USBRoot%"\Boot\BCD /set {default} description "%LiveTitle% - Windows PE 4 USB (amd64)"
bcdedit /store "%USBRoot%"\Boot\BCD /set {default} osdevice ramdisk=[boot]\sources\bootpe4amd64.wim,{ramdiskoptions}
bcdedit /store "%USBRoot%"\Boot\BCD /set {default} device ramdisk=[boot]\sources\bootpe4amd64.wim,{ramdiskoptions}
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%USBRoot%"\Boot\BCD /copy {ramdiskoptions} /d "%LiveTitle% - Windows PE 4 USB (x86)"') do set ramdisk=%1
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%USBRoot%"\Boot\BCD /copy {default} /d "%LiveTitle% - Windows PE 4 USB (x86)"') do set entry=%1
bcdedit /store "%USBRoot%"\Boot\BCD /set %entry% osdevice ramdisk=[boot]\sources\bootpe4x86.wim,%ramdisk%
bcdedit /store "%USBRoot%"\Boot\BCD /set %entry% device ramdisk=[boot]\sources\bootpe4x86.wim,%ramdisk%
bcdedit /store "%USBRoot%"\Boot\BCD /displayorder %entry% /addlast</code></pre>
<p>Build boot configuration database (BCD) store for PXE boot.</p>
<pre><code class="batch language-batch">bcdedit /store "%TFTPRoot%"\Boot\BCD /set {bootmgr} displaybootmenu true
bcdedit /store "%TFTPRoot%"\Boot\BCD /create {ramdiskoptions} /d "%LiveTitle% - Windows PE 4 PXE (amd64)"
bcdedit /store "%TFTPRoot%"\Boot\BCD /set {ramdiskoptions} ramdisksdidevice boot
bcdedit /store "%TFTPRoot%"\Boot\BCD /set {ramdiskoptions} ramdisksdipath \boot\boot.sdi
bcdedit /store "%TFTPRoot%"\Boot\BCD /set {default} description "%LiveTitle% - Windows PE 4 PXE (amd64)"
bcdedit /store "%TFTPRoot%"\Boot\BCD /set {default} osdevice ramdisk=[boot]\sources\bootpe4amd64.wim,{ramdiskoptions}
bcdedit /store "%TFTPRoot%"\Boot\BCD /set {default} device ramdisk=[boot]\sources\bootpe4amd64.wim,{ramdiskoptions}
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%TFTPRoot%"\Boot\BCD /copy {ramdiskoptions} /d "%LiveTitle% - Windows PE 4 PXE (x86)"') do set ramdisk=%1
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%TFTPRoot%"\Boot\BCD /copy {default} /d "%LiveTitle% - Windows PE 4 PXE (x86)"') do set entry=%1
bcdedit /store "%TFTPRoot%"\Boot\BCD /set %entry% osdevice ramdisk=[boot]\sources\bootpe4x86.wim,%ramdisk%
bcdedit /store "%TFTPRoot%"\Boot\BCD /set %entry% device ramdisk=[boot]\sources\bootpe4x86.wim,%ramdisk%
bcdedit /store "%TFTPRoot%"\Boot\BCD /displayorder %entry% /addlast</code></pre>
<h2 id="5-prepare-windows-pe-3">5 Prepare Windows PE 3</h2>
<p>Proceed using the same <em>Deployment and Imaging Tools Environment</em> command prompt as <strong>Administrator</strong> to prepare the startup environment for Windows PE.</p>
<h3 id="51-import-windows-aik-environment">5.1 Import Windows AIK Environment</h3>
<p>By importing the Windows AIK environment, we ensure that the tools that are being used are from the AIK and not the ADK.</p>
<pre><code class="batch language-batch">call "%AIK%"\Tools\PETools\pesetenv.cmd</code></pre>
<h3 id="52-prepare-x86-image">5.2 Prepare x86 Image</h3>
<p>Create a new Windows PE 3 image for x86.</p>
<pre><code class="batch language-batch">copype.cmd x86 "%PE3x86%"</code></pre>
<p>Mount the new x86 Windows PE 3 image.</p>
<pre><code class="batch language-batch">imagex /mountrw "%PE3x86%"\winpe.wim 1 "%PE3x86%"\mount</code></pre>
<p>Add packages to Windows PE 3 x86 image.</p>
<pre><code class="batch language-batch">dism /image:"%PE3x86%"\mount /Add-Package /PackagePath:"%pe3cabsx86%\winpe-wmi.cab"
dism /image:"%PE3x86%"\mount /Add-Package /PackagePath:"%pe3cabsx86%\winpe-scripting.cab"
dism /image:"%PE3x86%"\mount /Add-Package /PackagePath:"%pe3cabsx86%\winpe-hta.cab"
imagex /commit "%PE3x86%"\mount</code></pre>
<p>Install custom scripts into Windows PE 3 x86 image.</p>
<pre><code class="batch language-batch">copy /Y "%LiveScripts%"\startnet.cmd "%PE3x86%"\mount\Windows\System32
copy /Y "%LiveScripts%"\bootstrap.js "%PE3x86%"\mount\Windows\System32
imagex /commit "%PE3x86%"\mount</code></pre>
<h3 id="53-prepare-amd64-image">5.3 Prepare amd64 Image</h3>
<p>Create a new Windows PE 3 image for amd64.</p>
<pre><code class="batch language-batch">copype.cmd amd64 "%PE3amd64%"</code></pre>
<p>Mount the new amd64 Windows PE 3 image.</p>
<pre><code class="batch language-batch">imagex /mountrw "%PE3amd64%"\winpe.wim 1 "%PE3amd64%"\mount</code></pre>
<p>Add packages to Windows PE 3 amd64 image.</p>
<pre><code class="batch language-batch">dism /image:"%PE3amd64%"\mount /Add-Package /PackagePath:"%pe3cabsamd64%\winpe-wmi.cab"
dism /image:"%PE3amd64%"\mount /Add-Package /PackagePath:"%pe3cabsamd64%\winpe-scripting.cab"
dism /image:"%PE3amd64%"\mount /Add-Package /PackagePath:"%pe3cabsamd64%\winpe-hta.cab"
imagex /commit "%PE3amd64%"\mount</code></pre>
<p>Install custom scripts into Windows PE 3 amd64 image.</p>
<pre><code class="batch language-batch">copy /Y "%LiveScripts%"\startnet.cmd "%PE3amd64%"\mount\Windows\System32
copy /Y "%LiveScripts%"\bootstrap.js "%PE3amd64%"\mount\Windows\System32
imagex /commit "%PE3amd64%"\mount</code></pre>
<h3 id="54-prepare-ia64-image">5.4 Prepare ia64 Image</h3>
<p>Create a new Windows PE 3 image for ia64.</p>
<pre><code class="batch language-batch">copype.cmd ia64 "%PE3ia64%"</code></pre>
<p>Mount the new ia64 Windows PE 3 image.</p>
<pre><code class="batch language-batch">imagex /mountrw "%PE3ia64%"\winpe.wim 1 "%PE3ia64%"\mount</code></pre>
<p>Add packages to Windows PE 3 ia64 image.</p>
<pre><code class="batch language-batch">dism /image:"%PE3ia64%"\mount /Add-Package /PackagePath:"%pe3cabsia64%\winpe-wmi.cab"
dism /image:"%PE3ia64%"\mount /Add-Package /PackagePath:"%pe3cabsia64%\winpe-scripting.cab"
dism /image:"%PE3ia64%"\mount /Add-Package /PackagePath:"%pe3cabsia64%\winpe-hta.cab"
imagex /commit "%PE3ia64%"\mount</code></pre>
<p>Install custom scripts into Windows PE 3 ia64 image.</p>
<pre><code class="batch language-batch">copy /Y "%LiveScripts%"\startnet.cmd "%PE3ia64%"\mount\Windows\System32
copy /Y "%LiveScripts%"\bootstrap.js "%PE3ia64%"\mount\Windows\System32
imagex /commit "%PE3ia64%"\mount</code></pre>
<h3 id="55-assemble-windows-pe-3-for-isousbtftp-boot">5.5 Assemble Windows PE 3 for ISO/USB/TFTP Boot</h3>
<p>Copy files needed for x86 ISO boot.</p>
<pre><code class="batch language-batch">copy /Y "%PE3x86%"\winpe.wim "%ISORoot%"\x86\sources\bootpe3x86.wim</code></pre>
<p>Copy files needed for amd64 ISO boot.</p>
<pre><code class="batch language-batch">copy /Y "%PE3amd64%"\winpe.wim "%ISORoot%"\amd64\sources\bootpe3amd64.wim</code></pre>
<p>Copy files needed for ia64 ISO boot.</p>
<pre><code class="batch language-batch">xcopy /E /Y "%PE3ia64%"\ISO\*.* "%ISORoot%"\ia64
copy /Y "%PE3ia64%"\winpe.wim "%ISORoot%"\ia64\sources\boot.wim</code></pre>
<p>Copy files needed for USB boot.</p>
<pre><code class="batch language-batch">copy /Y "%PE3x86%"\winpe.wim "%USBRoot%"\sources\bootpe3x86.wim
copy /Y "%PE3amd64%"\winpe.wim "%USBRoot%"\sources\bootpe3amd64.wim
copy /Y "%PE3ia64%"\winpe.wim "%USBRoot%"\sources\bootpe3ia64.wim</code></pre>
<p>Deploy all images to TFTP root.</p>
<pre><code class="batch language-batch">copy /Y "%PE3x86%"\winpe.wim "%TFTPRoot%"\sources\bootpe3x86.wim
copy /Y "%PE3amd64%"\winpe.wim "%TFTPRoot%"\sources\bootpe3amd64.wim
copy /Y "%PE3ia64%"\winpe.wim "%TFTPRoot%"\sources\bootpe3ia64.wim</code></pre>
<h3 id="56-unmount-windows-pe-3-images">5.6 Unmount Windows PE 3 images</h3>
<p>Unmount all images.</p>
<pre><code class="batch language-batch">imagex /unmount "%PE3x86%"\mount
imagex /unmount "%PE3amd64%"\mount
imagex /unmount "%PE3ia64%"\mount</code></pre>
<h3 id="57-update-bcd-stores">5.7 Update BCD Stores</h3>
<p>Edit boot configuration database (BCD) store for x86 ISO container.</p>
<pre><code class="batch language-batch">for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%ISORoot%"\x86\Boot\BCD /copy {ramdiskoptions} /d "%LiveTitle% - Windows PE 3 CD (x86)"') do set ramdisk=%1
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%ISORoot%"\x86\Boot\BCD /copy {default} /d "%LiveTitle% - Windows PE 3 CD (x86)"') do set entry=%1
bcdedit /store "%ISORoot%"\x86\Boot\BCD /set %entry% osdevice ramdisk=[boot]\sources\bootpe3x86.wim,%ramdisk%
bcdedit /store "%ISORoot%"\x86\Boot\BCD /set %entry% device ramdisk=[boot]\sources\bootpe3x86.wim,%ramdisk%
bcdedit /store "%ISORoot%"\x86\Boot\BCD /displayorder %entry% /addlast</code></pre>
<p>Edit boot configuration database (BCD) store for amd64 ISO container.</p>
<pre><code class="batch language-batch">for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%ISORoot%"\amd64\Boot\BCD /copy {ramdiskoptions} /d "%LiveTitle% - Windows PE 3 CD (amd64)"') do set ramdisk=%1
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%ISORoot%"\amd64\Boot\BCD /copy {default} /d "%LiveTitle% - Windows PE 3 CD (amd64)"') do set entry=%1
bcdedit /store "%ISORoot%"\amd64\Boot\BCD /set %entry% osdevice ramdisk=[boot]\sources\bootpe3amd64.wim,%ramdisk%
bcdedit /store "%ISORoot%"\amd64\Boot\BCD /set %entry% device ramdisk=[boot]\sources\bootpe3amd64.wim,%ramdisk%
bcdedit /store "%ISORoot%"\amd64\Boot\BCD /displayorder %entry% /addlast</code></pre>
<p>Edit boot configuration database (BCD) store for ia64 ISO container.</p>
<pre><code class="batch language-batch">bcdedit /store "%ISORoot%"\ia64\EFI\Microsoft\Boot\BCD /create {ramdiskoptions} /d "%LiveTitle% - Windows PE 3 CD (ia64)"
bcdedit /store "%ISORoot%"\ia64\EFI\Microsoft\Boot\BCD /set {ramdiskoptions} ramdisksdidevice boot
bcdedit /store "%ISORoot%"\ia64\EFI\Microsoft\Boot\BCD /set {ramdiskoptions} ramdisksdipath \boot\boot.sdi
bcdedit /store "%ISORoot%"\ia64\EFI\Microsoft\Boot\BCD /set {default} description "%LiveTitle% - Windows PE 3 CD (ia64)"
bcdedit /store "%ISORoot%"\ia64\EFI\Microsoft\Boot\BCD /set {default} osdevice ramdisk=[boot]\sources\boot.wim,{ramdiskoptions}
bcdedit /store "%ISORoot%"\ia64\EFI\Microsoft\Boot\BCD /set {default} device ramdisk=[boot]\sources\boot.wim,{ramdiskoptions}</code></pre>
<p>Integrate Windows PE 3 into existing boot configuration database (BCD) store for USB boot.</p>
<pre><code class="batch language-batch">bcdedit /store "%USBRoot%"\Boot\BCD /set {bootmgr} displaybootmenu true
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%USBRoot%"\Boot\BCD /copy {ramdiskoptions} /d "%LiveTitle% - Windows PE 3 USB (amd64)"') do set ramdisk=%1
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%USBRoot%"\Boot\BCD /copy {default} /d "%LiveTitle% - Windows PE 3 USB (amd64)"') do set entry=%1
bcdedit /store "%USBRoot%"\Boot\BCD /set %entry% osdevice ramdisk=[boot]\sources\bootpe3amd64.wim,%ramdisk%
bcdedit /store "%USBRoot%"\Boot\BCD /set %entry% device ramdisk=[boot]\sources\bootpe3amd64.wim,%ramdisk%
bcdedit /store "%USBRoot%"\Boot\BCD /displayorder %entry% /addlast
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%USBRoot%"\Boot\BCD /copy {ramdiskoptions} /d "%LiveTitle% - Windows PE 3 USB (ia64)"') do set ramdisk=%1
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%USBRoot%"\Boot\BCD /copy {default} /d "%LiveTitle% - Windows PE 3 USB (ia64)"') do set entry=%1
bcdedit /store "%USBRoot%"\Boot\BCD /set %entry% osdevice ramdisk=[boot]\sources\bootpe3ia64.wim,%ramdisk%
bcdedit /store "%USBRoot%"\Boot\BCD /set %entry% device ramdisk=[boot]\sources\bootpe3ia64.wim,%ramdisk%
bcdedit /store "%USBRoot%"\Boot\BCD /displayorder %entry% /addlast
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%USBRoot%"\Boot\BCD /copy {ramdiskoptions} /d "%LiveTitle% - Windows PE 3 USB (x86)"') do set ramdisk=%1
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%USBRoot%"\Boot\BCD /copy {default} /d "%LiveTitle% - Windows PE 3 USB (x86)"') do set entry=%1
bcdedit /store "%USBRoot%"\Boot\BCD /set %entry% osdevice ramdisk=[boot]\sources\bootpe3x86.wim,%ramdisk%
bcdedit /store "%USBRoot%"\Boot\BCD /set %entry% device ramdisk=[boot]\sources\bootpe3x86.wim,%ramdisk%
bcdedit /store "%USBRoot%"\Boot\BCD /displayorder %entry% /addlast</code></pre>
<p>Integrate Windows PE 3 into existing boot configuration database (BCD) store for PXE boot.</p>
<pre><code class="batch language-batch">bcdedit /store "%TFTPRoot%"\Boot\BCD /set {bootmgr} displaybootmenu true
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%TFTPRoot%"\Boot\BCD /copy {ramdiskoptions} /d "%LiveTitle% - Windows PE 3 PXE (amd64)"') do set ramdisk=%1
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%TFTPRoot%"\Boot\BCD /copy {default} /d "%LiveTitle% - Windows PE 3 PXE (amd64)"') do set entry=%1
bcdedit /store "%TFTPRoot%"\Boot\BCD /set %entry% osdevice ramdisk=[boot]\sources\bootpe3amd64.wim,%ramdisk%
bcdedit /store "%TFTPRoot%"\Boot\BCD /set %entry% device ramdisk=[boot]\sources\bootpe3amd64.wim,%ramdisk%
bcdedit /store "%TFTPRoot%"\Boot\BCD /displayorder %entry% /addlast
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%TFTPRoot%"\Boot\BCD /copy {ramdiskoptions} /d "%LiveTitle% - Windows PE 3 PXE (ia64)"') do set ramdisk=%1
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%TFTPRoot%"\Boot\BCD /copy {default} /d "%LiveTitle% - Windows PE 3 PXE (ia64)"') do set entry=%1
bcdedit /store "%TFTPRoot%"\Boot\BCD /set %entry% osdevice ramdisk=[boot]\sources\bootpe3ia64.wim,%ramdisk%
bcdedit /store "%TFTPRoot%"\Boot\BCD /set %entry% device ramdisk=[boot]\sources\bootpe3ia64.wim,%ramdisk%
bcdedit /store "%TFTPRoot%"\Boot\BCD /displayorder %entry% /addlast
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%TFTPRoot%"\Boot\BCD /copy {ramdiskoptions} /d "%LiveTitle% - Windows PE 3 PXE (x86)"') do set ramdisk=%1
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%TFTPRoot%"\Boot\BCD /copy {default} /d "%LiveTitle% - Windows PE 3 PXE (x86)"') do set entry=%1
bcdedit /store "%TFTPRoot%"\Boot\BCD /set %entry% osdevice ramdisk=[boot]\sources\bootpe3x86.wim,%ramdisk%
bcdedit /store "%TFTPRoot%"\Boot\BCD /set %entry% device ramdisk=[boot]\sources\bootpe3x86.wim,%ramdisk%
bcdedit /store "%TFTPRoot%"\Boot\BCD /displayorder %entry% /addlast</code></pre>
<h2 id="6-deploy-windows-pe-media">6 Deploy Windows PE Media</h2>
<h3 id="61-generate-x86-iso-image">6.1 Generate x86 ISO Image</h3>
<p>Generate x86 image file.</p>
<pre><code class="batch language-batch">oscdimg -n -m -o -b"%PE4x86%"\fwfiles\etfsboot.com "%ISORoot%"\x86 "%ISORoot%"\x86.iso</code></pre>
<h3 id="62-generate-amd64-iso-image">6.2 Generate amd64 ISO Image</h3>
<p>Generate amd64 image file.</p>
<pre><code class="batch language-batch">oscdimg -n -m -o -b"%PE4amd64%"\fwfiles\etfsboot.com "%ISORoot%"\amd64 "%ISORoot%"\amd64.iso</code></pre>
<h3 id="63-generate-ia64-iso-image">6.3 Generate ia64 ISO Image</h3>
<p>Generate ia64 image file.</p>
<pre><code class="batch language-batch">oscdimg -n -m -o -b"%PE3ia64%"\efisys.bin "%ISORoot%"\ia64 "%ISORoot%"\ia64.iso</code></pre>
<h3 id="64-generate-x86amd64-combination-iso-image">6.4 Generate x86/amd64 Combination ISO Image</h3>
<p>Gather all the files needed.</p>
<pre><code class="batch language-batch">xcopy /S /Y "%ISORoot%"\x86\*.* "%ISORoot%"\x86amd64combo
copy /Y "%ISORoot%"\amd64\sources\*.* "%ISORoot%"\x86amd64combo\sources
copy /Y "%ISORoot%"\amd64\sources\*.* "%ISORoot%"\x86amd64combo\sources
copy /Y "%PE4amd64%"\media\Boot\BCD %ISORoot%"\x86amd64combo\Boot</code></pre>
<p>Edit boot configuration database (BCD) store for x86/amd64 combined ISO container.</p>
<pre><code class="batch language-batch">bcdedit /store "%ISORoot%"\x86amd64combo\Boot\BCD /set {bootmgr} displaybootmenu true
bcdedit /store "%ISORoot%"\x86amd64combo\Boot\BCD /create {ramdiskoptions} /d "%LiveTitle% - Windows PE 4 DVD (amd64)"
bcdedit /store "%ISORoot%"\x86amd64combo\Boot\BCD /set {ramdiskoptions} ramdisksdidevice boot
bcdedit /store "%ISORoot%"\x86amd64combo\Boot\BCD /set {ramdiskoptions} ramdisksdipath \boot\boot.sdi
bcdedit /store "%ISORoot%"\x86amd64combo\Boot\BCD /set {default} description "%LiveTitle% - Windows PE 4 DVD (amd64)"
bcdedit /store "%ISORoot%"\x86amd64combo\Boot\BCD /set {default} osdevice ramdisk=[boot]\sources\bootpe4amd64.wim,{ramdiskoptions}
bcdedit /store "%ISORoot%"\x86amd64combo\Boot\BCD /set {default} device ramdisk=[boot]\sources\bootpe4amd64.wim,{ramdiskoptions}
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%ISORoot%"\x86amd64combo\Boot\BCD /copy {ramdiskoptions} /d "%LiveTitle% - Windows PE 4 DVD (x86)"') do set ramdisk=%1
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%ISORoot%"\x86amd64combo\Boot\BCD /copy {default} /d "%LiveTitle% - Windows PE 4 DVD (x86)"') do set entry=%1
bcdedit /store "%ISORoot%"\x86amd64combo\Boot\BCD /set %entry% osdevice ramdisk=[boot]\sources\bootpe4x86.wim,%ramdisk%
bcdedit /store "%ISORoot%"\x86amd64combo\Boot\BCD /set %entry% device ramdisk=[boot]\sources\bootpe4x86.wim,%ramdisk%
bcdedit /store "%ISORoot%"\x86amd64combo\Boot\BCD /displayorder %entry% /addlast
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%ISORoot%"\x86amd64combo\Boot\BCD /copy {ramdiskoptions} /d "%LiveTitle% - Windows PE 3 DVD (amd64)"') do set ramdisk=%1
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%ISORoot%"\x86amd64combo\Boot\BCD /copy {default} /d "%LiveTitle% - Windows PE 3 DVD (amd64)"') do set entry=%1
bcdedit /store "%ISORoot%"\x86amd64combo\Boot\BCD /set %entry% osdevice ramdisk=[boot]\sources\bootpe3amd64.wim,%ramdisk%
bcdedit /store "%ISORoot%"\x86amd64combo\Boot\BCD /set %entry% device ramdisk=[boot]\sources\bootpe3amd64.wim,%ramdisk%
bcdedit /store "%ISORoot%"\x86amd64combo\Boot\BCD /displayorder %entry% /addlast
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%ISORoot%"\x86amd64combo\Boot\BCD /copy {ramdiskoptions} /d "%LiveTitle% - Windows PE 3 DVD (x86)"') do set ramdisk=%1
for /F "tokens=7 delims=. " %1 in ('bcdedit /store "%ISORoot%"\x86amd64combo\Boot\BCD /copy {default} /d "%LiveTitle% - Windows PE 3 DVD (x86)"') do set entry=%1
bcdedit /store "%ISORoot%"\x86amd64combo\Boot\BCD /set %entry% osdevice ramdisk=[boot]\sources\bootpe3x86.wim,%ramdisk%
bcdedit /store "%ISORoot%"\x86amd64combo\Boot\BCD /set %entry% device ramdisk=[boot]\sources\bootpe3x86.wim,%ramdisk%
bcdedit /store "%ISORoot%"\x86amd64combo\Boot\BCD /displayorder %entry% /addlast</code></pre>
<p>Generate x86/amd64 image file.</p>
<pre><code class="batch language-batch">oscdimg -n -m -o -b"%PE4x86%"\fwfiles\etfsboot.com "%ISORoot%"\x86amd64combo "%ISORoot%"\x86amd64combo.iso</code></pre>
<h3 id="65-clean-up">6.5 Clean up</h3>
<p><em>Optional:</em> Remove temporary build environments.</p>
<pre><code class="batch language-batch">rmdir /S /Q "%PE4x86%"
rmdir /S /Q "%PE4amd64%"

rmdir /S /Q "%PE3x86%"
rmdir /S /Q "%PE3amd64%"
rmdir /S /Q "%PE3ia64%"

rmdir /S /Q "%ISORoot%"\x86
rmdir /S /Q "%ISORoot%"\amd64
rmdir /S /Q "%ISORoot%"\ia64
rmdir /S /Q "%ISORoot%"\x86amd64combo</code></pre>
<h3 id="66-copy-your-installation-media">6.6 Copy Your Installation Media</h3>
<p>Copy all of your installation media into folders/subfolders inside the <code>%LiveDrive%\media</code> folder. The scripts provided earlier will automatically detect the available installation media and provide an interface to launch whichever Windows Setup instances are valid for the given Windows PE session that is booted.</p>
<p><strong>NOTICE: The scripts do not currently do this. It is a planned feature for the next release of this article.</strong></p>
<h3 id="67-prepare-installation-media-for-usb-deployment">6.7 Prepare Installation Media for USB Deployment</h3>
<p>Now that all of the installation files are tucked away safely inside of <code>%LiveDrive%\media</code>, you can adjust the contents of the <code>%USBRoot%\media</code> folder as well. You can either copy them directly or create links as I have done.</p>
<pre><code class="batch language-batch">for %f in ("%LiveMedia%"\*) do mklink "%USBRoot%\media\%~nf" "%f"
for /d %d in ("%LiveMedia%"\*) do mklink /d "%USBRoot%\media\%~nd" "%d"</code></pre>
<h3 id="68-deploy-usb-root-to-usb-drive">6.8 Deploy USB Root to USB Drive</h3>
<p>You will need a USB drive formatted to FAT32 or NTFS (recommended). If it was not formatted in Windows Vista or higher, you may use <code>bootsect.exe</code> to update the master boot record and partition record so that it is using the BOOTMGR boot code. The syntax is as follows:</p>
<pre><code class="batch language-batch">bootsect /nt60 &lt;USBDriveLetter&gt;: /mbr</code></pre>
<p>Replace <code>&lt;USBDriveLetter&gt;</code> with the drive letter of your USB drive. Run <code>bootsect /help</code> for further information.</p>
<p>Then just copy the contents of your <code>%USBRoot%</code> folder to your USB drive's root directory.</p>
<pre><code class="batch language-batch">xcopy /E /Y %USBRoot% &lt;USBDriveLetter&gt;:\</code></pre>
<p>Replace <code>&lt;USBDriveLetter&gt;</code> with the drive letter of your USB drive.</p>
<h2 id="7-setup-technician-pc-services">7 Setup Technician PC Services</h2>
<p>I have chosen to use Open DHCP Server and Open TFTP Server for this portion of the setup. You may use what you want, but this is the configuration I chose because my Technician PC is also a workstation PC.</p>
<h3 id="71-tftp-server-setup">7.1 TFTP Server Setup</h3>
<p>Setup Open TFTP Server.</p>
<p>Backup <code>C:\OpenTFTPServer\OpenTFTPServerMT.ini</code>.</p>
<pre><code class="batch language-batch">copy "C:\OpenTFTPServer\OpenTFTPServerMT.ini" "C:\OpenTFTPServer\OpenTFTPServerMT.ini.original"</code></pre>
<p>Edit <code>C:\OpenTFTPServer\OpenTFTPServerMT.ini</code> so that it says something like:</p>
<pre><code class="ini language-ini">[LISTEN-ON]
#192.168.1.100
[HOME]
C:\LiveDrive\TFTPRoot
[LOGGING]
Errors
[TFTP-OPTIONS]
blksize=65464</code></pre>
<p>Restart service:</p>
<pre><code class="batch language-batch">net stop TFTPServer
net start TFTPServer</code></pre>
<h3 id="72-dhcp-server-setup">7.2 DHCP Server Setup</h3>
<p>Setup Open DHCP Server.</p>
<p>Backup <code>C:\OpenDHCPServer\OpenDHCPServer.ini</code>.</p>
<pre><code class="batch language-batch">copy "C:\OpenDHCPServer\OpenDHCPServer.ini" "C:\OpenDHCPServer\OpenDHCPServer.ini.original"</code></pre>
<p>Edit <code>C:\OpenDHCPServer\OpenDHCPServer.ini</code> so that it says something like:</p>
<pre><code class="ini language-ini">[LISTEN_ON]
#192.168.1.100
[LOGGING]
LogLevel=Normal
[RANGE_SET]
DHCPRange=192.168.1.25-192.168.1.75
SubnetMask=255.255.255.0
DomainServer=192.168.1.1,8.8.8.8,8.8.4.4
Router=192.168.1.1
NameServer=192.168.1.1
NextServer=192.168.1.100
BootFileSize=3170304
BootFileName=\Boot\wdsnbp.com</code></pre>
<p>Restart service:</p>
<pre><code class="batch language-batch">net stop OpenDHCPServer
net start OpenDHCPServer</code></pre>
<h3 id="73-web-server-setup">7.3 Web Server Setup</h3>
<h2 id="8-product-testing">8 Product Testing</h2>
<p>With the exception of USB booting, I use a VirtualBox virtual machine to test all of these boot scenarios. <a href="http://www.virtualbox.org/" target="_blank">VirtualBox</a> doesn't boot directly from USB, so I use a second PC to test USB booting. All of these boot patterns have been tested and work according to design.</p>
<p>If you have any comments or suggestions for improvement, please drop me a line below or find me on Google+. Enjoy the fruits of your labor!</p></p></div></div><div class="card"><div class="card-body"><div id="disqus_thread"></div><script type="text/javascript">var disqus_identifier = '520606022bbfd30200000003';
var disqus_title = 'Technician Tools Live Drive';
/* var disqus_url = '{{ site.url }}{{ site.base_url }}{{ page.url }}'; */</script><noscript>Please enable JavaScript to view the
 <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.</noscript></div></div><div class="card"><div class="card-body"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle d-block" data-ad-client="ca-pub-8937572456576531" data-ad-slot="5297465010" data-ad-format="auto"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div><a class="github-corner d-none d-lg-inline" href="https://github.com/daball/daball.github.io/tree/src"><svg class="github-corner" width="80" title="View source on GitHub" data-toggle="tooltip" data-placement="left" height="80" viewBox="0 0 250 250" style="position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path class="octo-arm" d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;"></path><path class="octo-body" d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9, 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor"></path></svg></a><!-- Google Analytics--><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-3984008-3']);
_gaq.push(['_trackPageview']);
(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script><!-- Bootstrap core JavaScript--><script src="/vendor/jquery/jquery.min.js"></script><script src="/vendor/popper.js/dist/popper.min.js"></script><script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script><!-- Plugin JavaScript--><script src="/vendor/jquery-easing/jquery.easing.min.js"></script><!-- Custom scripts for this template--><script src="/layouts/blog/js/blog.min.js"></script><script type="text/javascript"><var>disqus_shortname = 'daball';</var></script><script>(function () {
  var s = document.createElement('script'); s.async = true;
  s.type = 'text/javascript';
  s.src = '//' + daball + '.disqus.com/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());</script><script>/* var disqus_config = function () {
  // Replace PAGE_URL with your page's canonical URL variable
  this.page.url = PAGE_URL;  
    
  // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  this.page.identifier = PAGE_IDENTIFIER; 
}; */
(function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://daball.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();</script></body></html>